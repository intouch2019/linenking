<?php
include "checkAccess.php";
require_once "../../it_config.php";
require_once "lib/db/DBConn.php";
print "0::success";return;
/** Sync disabled on-> 24th Aug '15 
 * reason -> due some reason failing for some store and setting all as '0' n nt updating the correct values
 * **/
extract($_POST);
//print_r($record);
if (!isset($record) || trim($record) == "") {
	print "1::Missing parameter";
	return;
}
//$record = "1<>8900000002054<>3<++>1<>8900000002061<>2<++>1<>8900000002078<>1<++>1<>8900000002092<>2<++>1<>8900000002139<>2<++>1<>8900000002146<>2<++>1<>8900000002214<>1<++>1<>8900000002221<>2<++>1<>8900000002238<>1<++>1<>8900000002252<>1<++>1<>8900000002269<>1<++>1<>8900000002276<>1<++>1<>8900000002290<>1<++>1<>8900000002306<>2<++>1<>8900000002313<>2<++>1<>8900000002375<>2<++>1<>8900000002382<>2<++>1<>8900000002399<>2<++>1<>8900000002429<>2<++>1<>8900000002436<>1<++>1<>8900000002450<>2<++>1<>8900000002467<>2<++>1<>8900000002504<>1<++>1<>8900000002535<>2<++>1<>8900000002542<>2<++>1<>8900000002559<>1<++>1<>8900000002580<>1<++>1<>8900000002597<>1<++>1<>8900000002610<>1<++>1<>8900000002627<>1<++>1<>8900000002634<>2<++>1<>8900000002641<>1<++>1<>8900000002665<>1<++>1<>8900000002672<>1<++>1<>8900000002696<>1<++>1<>8900000002788<>1<++>1<>8900000002795<>2<++>1<>8900000002818<>1<++>1<>8900000002825<>2<++>1<>8900000002832<>1<++>1<>8900000002863<>2<++>1<>8900000002870<>1<++>1<>8900000002948<>2<++>1<>8900000002986<>2<++>1<>8900000002993<>1<++>1<>8900000003013<>1<++>1<>8900000003037<>1<++>1<>8900000003044<>2<++>1<>8900000003051<>1<++>1<>8900000003068<>2<++>1<>8900000003075<>1<++>1<>8900000003082<>1<++>1<>8900000003099<>2<++>1<>8900000003105<>2<++>1<>8900000003112<>2<++>1<>8900000003129<>1<++>1<>8900000003136<>1<++>1<>8900000003143<>2<++>1<>8900000003150<>1<++>1<>8900000003174<>4<++>1<>8900000003181<>3<++>1<>8900000003198<>4<++>1<>8900000003204<>2<++>1<>8900000003211<>1<++>1<>8900000003228<>3<++>1<>8900000003235<>1<++>1<>8900000003242<>1<++>1<>8900000003259<>2<++>1<>8900000003266<>3<++>1<>8900000003273<>2<++>1<>8900000003280<>2<++>1<>8900000003297<>1<++>1<>8900000003303<>2<++>1<>8900000003310<>3<++>1<>8900000003327<>1<++>1<>8900000003341<>2<++>1<>8900000003358<>1<++>1<>8900000003365<>1<++>1<>8900000003372<>1<++>1<>8900000003389<>1<++>1<>8900000003396<>1<++>1<>8900000003419<>1<++>1<>8900000003426<>2<++>1<>8900000003433<>3<++>1<>8900000003457<>1<++>1<>8900000003464<>1<++>1<>8900000003471<>2<++>1<>8900000003488<>1<++>1<>8900000003495<>1<++>1<>8900000003501<>2<++>1<>8900000003518<>3<++>1<>8900000003525<>1<++>1<>8900000003532<>2<++>1<>8900000003549<>3<++>1<>8900000003556<>2<++>1<>8900000003570<>1<++>1<>8900000003594<>3<++>1<>8900000003679<>3<++>1<>8900000003686<>1<++>1<>8900000003693<>1<++>";
//$record = "6<==>8900000002054<>10<++>8900000002061<>20<++>";
//print_r($record);
try{
    $db = new DBConn();
    $arr = explode("<==>",$record);
    $store_id = $gCodeId;
    //$store_id =62;
//    print_r($arr);
    $sync_id = $arr[0];
//    echo "<br/>".$sync_id."<br/>";
    $query = " select * from  it_current_stock where  store_id = $store_id and ( sync_id < $sync_id or sync_id is null) ";        
//    echo "<br/>search qry $query<br/>";
    $exists = $db->fetchObject($query);
//    print_r($exists);
        if($exists){
//            $db->execQuery("delete from it_current_stock where id = $exists->id ");
             $upqry = "update it_current_stock set quantity = 0 , sync_id = null   where sync_id < $sync_id or sync_id is null and store_id = $store_id";
             $db->execUpdate($upqry);            
//             echo "<br/> update qry:- ".$upqry."<br/>";
        }

//    $recbatch = $arr[1];
    $arr1 = explode("<++>",$arr[1]);
    
    foreach($arr1 as $rec){
        if ($rec == "") { continue; }
        $currrec = explode("<>",$rec);
//        print_r($currrec);               
        $barcode = $db->safe($currrec[0]);
        $quantity = $currrec[1];
        
        $chkQry = "select * from it_current_stock where barcode = $barcode and store_id = $store_id ";
        $check = $db->fetchObject($chkQry);
        if($check){
            $updtQry = "update it_current_stock set quantity = $quantity , sync_id = $sync_id  where barcode = $barcode and store_id = $store_id ";
            $db->execQuery($updtQry);
        }else{
            $insQry = " insert into it_current_stock set barcode = $barcode , store_id = $store_id , quantity = $quantity , sync_id = $sync_id , createtime = now() ";
    //        echo "<br/> insert qry:- ".$insQry."<br/>";
            $db->execInsert($insQry);
        }
    
    }
    
    print "0::Success";
}catch(Exception $ex){
    print "1::Error-".$ex->getMessage();
}
?>
