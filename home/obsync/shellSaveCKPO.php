<?php
require_once "../../it_config.php";
include "checkAccess.php";

$commit=true;
require_once "lib/db/DBConn.php";
require_once "lib/core/strutil.php";
require_once "lib/core/Constants.php";

extract($_POST);
$record="113<==>Manik Stores <>Opposite Bharat Wollen House, ,<br/>Kunte Chowk, Lakhsmi Road<br/>PUNE : 411030<>27670056761 V<==>8900000022502<>1<++>8900000080779<>1<++>8900000083947<>2<++>8900000026999<>1<++>8900000072002<>1<++>8900000009985<>1<++>8900000009268<>1<++>8900000007059<>1<++>8900000081622<>1<++>8900000067817<>1<++>8900000018161<>2<++>8900000078578<>1<++>8900000045600<>1<++>8900000062256<>2<++>8900000068012<>1<++>8900000018222<>1<++>8900000018048<>1<++>8900000065929<>1<++>8900000052066<>3<++>8900000009848<>3<++>8900000052165<>3<++>8900000061921<>3<++>8900000079346<>3<++>8900000066094<>3<++>8900000036936<>1<++>8900000064311<>1<++>8900000064625<>1<++>8900000076963<>1<++>8900000064212<>1<++>8900000081936<>1<++>8900000043613<>1<++>8900000077564<>1<++>8900000077205<>1<++>8900000074075<>2<++>8900000052851<>1<++>8900000079285<>1<++>8900000076659<>1<++>8900000064779<>1<++>8900000081691<>1<++>8900000042821<>1<++>8900000061884<>1<++>8900000062263<>1<++>8900000084647<>2<++>8900000049585<>1<++>8900000064137<>1<++>8900000079988<>1<++>8900000054213<>1<++>8900000050581<>2<++>8900000080205<>1<++>8900000079858<>1<++>8900000078325<>1<++>8900000076642<>1<++>8900000073030<>2<++>8900000018031<>1<++>8900000015566<>2<++>8900000067510<>1<++>8900000076741<>1<++>8900000078622<>1<++>8900000006144<>1<++>8900000021390<>1<++>8900000048205<>2<++>8900000080007<>1<++>8900000076895<>1<++>8900000064618<>1<++>8900000077809<>1<++>8900000027002<>1<++>8900000077694<>1<++>8900000043668<>1<++>8900000074044<>1<++>8900000076758<>1<++>8900000081998<>1<++>8900000039715<>1<++>8900000070749<>1<++>8900000027248<>1<++>8900000052455<>1<++>8900000065486<>1<++>8900000046072<>1<++>8900000080953<>1<++>8900000002825<>1<++>8900000083237<>1<++>8900000070732<>2<++>8900000051052<>1<++>8900000055968<>2<++>8900000043361<>1<++>8900000073535<>1<++>8900000063567<>1<++>8900000006472<>1<++>8900000073733<>1<++>8900000044467<>1<++>8900000041619<>1<++>8900000006755<>1<++>8900000073634<>1<++>8900000021215<>1<++>8900000052493<>2<++>8900000060450<>1<++>8900000020102<>1<++>8900000018123<>1<++>8900000072446<>1<++>8900000050888<>1<++>8900000066339<>1<++>8900000015733<>1<++>8900000042524<>1<++>8900000077816<>1<++>8900000081981<>1<++>8900000082438<>1<++>8900000002375<>1<++>8900000016846<>1<++>8900000057078<>1<++>8900000080052<>1<++>8900000068449<>1<++>8900000027026<>1<++>8900000064687<>1<++>8900000082377<>1<++>8900000061891<>1<++>8900000063383<>1<++>8900000084180<>2<++>8900000070640<>1<++>8900000056644<>1<++>8900000036868<>1<++>8900000050505<>1<++>8900000006496<>1<++>8900000066322<>2<++>8900000066520<>2<++>8900000006113<>2<++>8900000082421<>1<++>8900000068074<>1<++>8900000079841<>1<++>8900000084449<>2<++>8900000052646<>1<++>8900000077236<>1<++>8900000051069<>1<++>8900000055975<>1<++>8900000047475<>1<++>8900000081943<>1<++>8900000067541<>1<++>8900000068296<>1<++>8900000081950<>1<++>8900000066629<>1<++>8900000005062<>1<++>8900000079193<>1<++>8900000077144<>1<++>8900000016068<>1<++>8900000070930<>1<++>8900000010349<>1<++>8900000070909<>1<++>8900000064250<>1<++>8900000005987<>1<++>8900000081646<>1<++>8900000020713<>1<++>8900000079186<>1<++>8900000080090<>2<++>8900000009763<>1<++>8900000070350<>1<++>8900000044498<>1<++>8900000005833<>1<++>8900000063727<>1<++>8900000008308<>1<++>8900000079735<>1<++>8900000021208<>1<++>8900000071845<>1<++>8900000063536<>1<++>8900000086146<>1<++>8900000002092<>1<++>8900000078646<>2<++>8900000079087<>1<++>8900000083930<>1<++>8900000064670<>1<++>8900000077366<>1<++>8900000066483<>1<++>8900000080250<>1<++>8900000047215<>1<++>8900000073047<>1<++>8900000084425<>1<++>8900000004072<>1<++>8900000022748<>1<++>8900000071043<>1<++>8900000073641<>1<++>8900000062362<>1<++>8900000056323<>1<++>8900000016945<>1<++>8900000047604<>1<++>8900000078028<>1<++>8900000061938<>1<++>8900000002917<>1<++>8900000084869<>1<++>8900000082605<>1<++>8900000009619<>1<++>8900000066421<>1<++>8900000080083<>1<++>8900000052752<>1<++>8900000084906<>1<++>8900000054800<>1<++>8900000081837<>1<++>8900000063376<>1<++>8900000020263<>1<++>";
if (!$record || trim($record) == "") {
	print "1::The order information is missing. Please make sure the receipt information is displayed before re-submitting.";
	return;
}

try {
	$db = new DBConn();
	$record = trim($record);
	$records = explode("<==>", $record);
	if (count($records) == 0) { throw new Exception("Incomplete order information"); }
	$po_number=$records[0];
	if (!isNumber($po_number)) { throw new Exception("PO Number is missing or invalid [$po_number]"); }
	$po_number = sprintf("SP%06d",intval($po_number));
	// $custInfo = $records[1];
	$itemlines = explode("<++>", $records[2]);
	$oitems = array();
	$order_qty = 0;
	$order_amt = 0;
	$designs = array();
$first=true;
	foreach ($itemlines as $currlineitem) {
		$currlineitem=trim($currlineitem);
		if ($currlineitem == "") { continue; }
if ($first) print "[$currlineitem]<br />";
		list($item_code, $quantity) = explode("<>", $currlineitem);
		$quantity = intval($quantity);
		// remove stock check
		$item = $db->fetchObject("select * from it_items where barcode='$item_code' and curr_qty > 0");
		//$item = $db->fetchObject("select * from it_items where barcode='$item_code'");
		if (!$item) { continue; }
		$designs[$item->design_no] = 1;
		// remove stock check
		$line_order_qty = $quantity < $item->curr_qty ? $quantity : $item->curr_qty;
		//$line_order_qty = $quantity;
		$oitems[$item->id]=(object)array("order_qty"=>$line_order_qty, "item" => $item);
		$order_qty += $line_order_qty;
		$order_amt += ($line_order_qty * $item->MRP);
	}

	if (count($oitems) >= 0) {
		$num_designs = count($designs);
		$store_id=62;
		if ($commit)
		$order_id=$db->execInsert("insert into it_ck_orders set store_id=$store_id, status=".OrderStatus::Active.", order_no='$po_number', order_qty=$order_qty, order_amount=$order_amt, num_designs=$num_designs, active_time=now()");
		print "insert into it_ck_orders set store_id=$store_id, status=".OrderStatus::Active.", order_no='$po_number', order_qty=$order_qty, order_amount=$order_amt, num_designs=$num_designs, active_time=now()\n";
		foreach ($oitems as $item_id => $oinfo) {
			$order_qty = $oinfo->order_qty;
			$item = $oinfo->item;
			if ($commit)
			$db->execInsert("insert into it_ck_orderitems set order_id=$order_id, store_id=$store_id, item_id='$item->id', design_no='$item->design_no', order_qty=$order_qty, MRP=$item->MRP");
			if ($commit)
			$db->execUpdate("update it_items set curr_qty = curr_qty - $order_qty where id=$item_id");
		}
	}
	print "0::Success";
} catch (Exception $ex) {
	$msg = print_r($ex,true);
	error_log($msg, 3, "/home/limelight/logs/limelight-error.log");
	print "1::Error-$msg";
}
$db->closeConnection();
