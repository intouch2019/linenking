<?php
require_once("../../../it_config.php");
//require_once "session_check.php";
require_once "lib/db/DBConn.php";
require_once "lib/core/Constants.php";
require_once "lib/grnPDFClass/GRN_PDF_Mail.php";
require "fpdf.php";

$call=new test_pdf;
$call->genUnreleasedPDF();

class test_pdf {

    function __construct() {
        
    }
    
    public function genUnreleasedPDF(){
        $img_path = '../images/stock/';
        //$img_path = '/var/www/cottonking_new/home/images/stock/';
        $pdf = new FPDF();
        $db = new DBConn();
//        $todays_date = date('Y-m-d');

        $pdf->AddPage();       
        if(!empty("1451")){
//            $itemids = implode(",", $item_ids_arr);
            $itemids="82242,82243,83179,128602,90263,90264,90488,128603,107150,111159,110493,107149,104232,104303,107147,104541,107148,109585,110612,110613,128601,112010,112011,113675,113676,113677,114685,114941,136954,117147,120681,135273,131264,129995,126269,129672,129673,129674,131262,130027,130028,130029,131323,131324,131325,131404,132116,132402,135272,135538,133692,137057,134075,134076,134077,134568,136452,136603,136995,137449,137450,137451,138113,139397,139398,139399,139400,139963,140260,141096,142380,145667,142992,149848,143465,149812,148273,144293,148255,144364,144408,145968,149687,145289,144859,144935,144945,144955,149941,145487,145631,145632,145633,145634,145635,145636,145637,145638,145677,145678,145679,145680,145688,145689,145690,145691,145714,145715,145716,145717,145718,145719,145720,145721,149846,145924,145798,145799,147184,145923,149849,145922,145925,148256,145926,145927,145928,145930,145932,145933,145934,145935,145936,145937,145938,145939,145956,145969,145970,145971,145972,145973,145974,145975,145976,145978,145979,145980,145981,145982,145983,145984,145985,145986,146000,146001,146002,146003,146005,146006,146020,146021,146022,146023,146024,146025,146026,146027,146028,147411,149963,149961,149960,149959,146394,146395,146396,146399,146420,146421,146422,146423,146425,146525,146667,146768,146801,146881,146912,149956,147032,147245,147280,147587,147290,147298,147319,147321,147460,147461,147588,147586,147589,147590,147591,147592,147593,147594,149940,147646,147647,147648,147649,147755,147756,148055,148286,149855,149962,149957,148451,148578,148579,148580,148583,148584,148586,148659,148660,148661,149847,149939,149240,149241,149242,149285,149286,149287,149288,149289,149290,149291,149345,149346,149347,149598,149599,149600,150167,150168,150179,150206,150231,150235,150250,150283,150284,150285,150286,150288,150289,150290,150293,150294,150295,150296,150303,150304,150305,150306,150326,150333,150334,150335,150336,150343,150344,150345,150346,150353,150354,150355,150356,150380,150396,150397,150398,150399,150401,150402,150406,150407,150408,150409,150410,150411,150412,150413,150414,150415,150416,150417,150418,150419,150501,150502,150503,150523,150524,150525,150526,150580,150610,150648,150649,150650,150651,150714,156546,150785,150786,150787,150803,150804,150805,150806,150832,150833,150834,150835,150836,150866,150975,150976,151018,151047,151048,151049,151050,151052,151053,151054,151055,151077,151080,151081,151082,151083,151084,151085,151086,157036,151102,151103,151104,151128,151129,151161,151282,157258,151335,151378,151405,151438,151439,151440,151450,151451,151452,156736,152428,151858,151859,156612,151930,151931,151932,151949,156558,156557,156556,155726,156547,156560,156603,156491,152003,152004,152095,152160,152167,152284,152286,152307,152319,152320,152323,152325,152336,156702,152407,152419,152429,152483,152484,152485,152537,152538,152539,152543,152555,152556,152557,152575,152597,152604,152605,152606,156545,154875,153244,153270,153266,153267,153268,153280,153281,153282,153414,157371,154774,157372,156740,157276,156551,153748,153749,153750,153751,153752,153753,153754,153755,156494,153958,153959,153961,153988,157408,156611,154025,154026,154027,154031,154200,154061,154062,156738,156550,156492,155044,154202,154203,154239,154240,154241,154242,156604,156605,156741,157275,157257,154307,154308,154309,154328,156555,156554,156553,154427,154447,154449,154457,154605,154606,154623,154624,154625,154626,156737,154876,154877,156639,154997,156559,155041,156739,155087,155088,155089,155090,155092,155093,155095,155116,155136,155154,155155,155156,157259,155166,155167,155168,155169,155170,155171,155172,155173,155174,155186,155202,155208,155212,155214,155218,155221,156493,155451,156487,156389,155227,155231,155244,155252,156549,155279,155286,155462,155343,155352,155353,155357,155361,155362,155363,155364,155365,155366,155369,155374,155378,157083,157160,157374,156548,156704,156039,155588,155590,155613,155627,155655,155727,155728,155729,155730,155731,155732,155733,155738,155770,155771,155772,155773,155775,155776,155778,157378,155877,155878,155879,155880,155881,155882,155883,155884,155885,155887,155912,155911,155913,156610,155946,155947,155948,155949,156658,155957,155958,155959,155988,155989,155990,155991,155992,155993,155994,155995,155996,156006,156008,156009,156010,156011,156012,156013,156014,156015,156016,156040,156041,156544,156097,156118,156117,156119,156120,156121,156122,156123,156124,156125,156159,156160,156161,156162,156163,156164,156165,156166,156167,156184,156185,156186,156202,156203,156204,156223,156224,156225,156227,156228,156229,156231,156232,156233,156234,156236,156237,156239,156247,156248,156249,156250,156251,156252,156253,156254,156255,156256,156257,156258,156259,156260,156261,156262,156263,156264,156265,156266,156267,156268,156270,156271,156311,156312,156313,156314,156331,156332,156333,156334,156362,156363,156364,156365,156366,156371,156372,156373,156374,156375,156376,156377,156378,156379,156380,156381,156382,156383,156384,156385,156386,156387,156388,156390,156391,156392,156393,156394,156395,156396,156397,156703,156417,156418,156419,156420,156422,156423,156424,156425,156437,156438,156439,156634,156640,156637,156636,156638,156635,156461,157370,156750,156602,156746,156747,156748,156705,156742,156751,156749,156745,156744,156477,156478,156479,156480,156485,156499,156500,156501,156502,156503,156504,156505,156506,156507,156508,156552,156513,156514,156515,156516,156517,156518,156519,156520,156529,156539,156540,156541,156799,156800,156801,156802,156810,156811,156812,156813,156814,156815,156816,156817,156818,156819,156820,156821,156822,156823,156824,156825,156826,156827,156828,156829,157008,157009,157010,157011,157012,157013,157014,157015,157037,157038,157039,157040,157041,157042,157043,157044,157045,157046,157047,157082,157084,157086,157087,157088,157089,157136,157137,157138,157139,157140,157141,157142,157143,157161,157162,157163,157274,157277,157184,157185,157186,157187,157188,157189,157190,157191,157192,157193,157194,157195,157196,157197,157198,157199,157200,157201,157202,157203,157229,157230,157231,157232,157233,157234,157245,157246,157247,157248,157253,157254,157255,157256,157260,157261,157262,157263,157264,157273,157278,157279,157280,157281,157282,157283,157284,157285,157286,157287,157301,157302,157303,157304,157309,157310,157311,157312,157321,157322,157323,157324,157325,157326,157327,157328,157329,157330,157331,157332,157337,157338,157339,157340,157345,157346,157347,157348,157349,157350,157351,157352,157362,157363,157364,157365,157366,157367,157368,157369,157373,157375,157376,157377,157379,157380,157381,157382,157383,157384,157385,157386,157387,157388,157389,157390,157391,157392,157393,157394,157395,157396,157397,157398,157399,157400,157401,157402,157403,157404,157405,157406,157407,157409,157410,157411,157412,157413,157414,157415,157416,157417,157418,157419,157420,157421,157422,157423,157424,157425,157426,157427,157428,157429,157430,157431,157432,157433,157434,157435,157436,157437,157438,157439,157440,157441,157442,157443,157444,157445,157446,157447,157448,157449,157450,157451,157452,157453,157454,157455,157456";
//            print_r($itemids);exit();
            //$query = "select c.name as ctg_name, i.design_no, i.mrp, cd.image as image_name,cd.extension , cdp.cdesp from it_items i  left join it_grn_ctg_desp cdp on i.ctg_id = cdp.ctg_id and i.design_id = cdp.design_id, it_categories c , it_ck_designs cd where i.ctg_id = c.id and c.id = cd.ctg_id and i.design_id = cd.id and i.id in ( $itemids ) group by i.ctg_id,i.design_id,i.mrp ";

          $query = "SELECT c.name AS ctg_name, i.design_no, i.mrp, cd.image AS image_name, cdp.cdesp, i.ctg_id, i.prod_type_id, (SELECT SUM(curr_qty) FROM it_items WHERE ctg_id = i.ctg_id AND design_no = i.design_no) AS total_available FROM it_items i LEFT JOIN it_grn_ctg_desp cdp ON i.ctg_id = cdp.ctg_id AND i.design_id = cdp.design_id JOIN it_categories c ON i.ctg_id = c.id JOIN it_ck_designs cd ON i.ctg_id = cd.ctg_id AND i.design_id = cd.id WHERE i.id IN ($itemids) GROUP BY i.ctg_id, i.design_id, i.mrp ORDER BY c.sequence";
//            print $query; exit();

            $all_items = $db->fetchObjectArray($query);
//            print_r($all_items);exit();
//            $db->closeConnection();
            $count=0;
            if(!empty($all_items)){
//                print_r("ssssssss");exit();
                 $icnt = 0;
                 $pdf->SetAutoPageBreak(true);
            foreach ($all_items as $item) {
//                  print_r($item); exit();
//                 $avl_query="select sum(curr_qty) as total_available from it_items where ctg_id= $item->ctg_id and design_no='".$item->design_no."'";
////                echo "<br>".$avl_query;//exit();
//                 $avl = $db->fetchObject($avl_query);
//                if(isset($avl) && $avl->total_available >25)
//                    print_r($avl->total_available); exit();
                  if (isset($item->total_available) && $item->total_available > 10){
                $count++;
//            print_r("ssssssss");exit();
                if($icnt > 2){
                    $icnt=0;
                     $pdf->AddPage();
//                     $y = 0;
                }
                    $icnt = $icnt + 1;
                $category_name = $item->ctg_name;
                $item_mrp = $item->mrp;
                $design_no = $item->design_no;
                $image = $item->image_name;
                
                
                $productionid = $item->prod_type_id;
                $productName="-";
                if(isset($productionid)){
                     $prodnameQuery="select name from it_prod_types where id=$productionid";
                     $prodName = $db->fetchObject($prodnameQuery);
                         if(isset($prodName)){
                     
                         $productName=$prodName->name;
                         
                         }
                }
                
                $pdf->SetFont('Arial', 'B', 16);
                $pdf->ln();
                $pdf->ln();
            //    $pdf->ln();
            //    $pdf->ln();
                if(file_exists($img_path.$image)){
                 $pdf->Image($img_path . $image, $pdf->GetX() + 0, $pdf->GetY(), 40);
                }
                // $pdf->ln();
                $pdf->cell(50);
                $pdf->Cell(40, 10, "Product Category: ".$category_name);
                $pdf->Ln();
            //$pdf->Image($img_path.$image,$pdf->GetX(), $pdf->GetY(),50 ,60);
                // $pdf->Ln();
                $pdf->cell(50);
                $pdf->Cell(40, 10, "MRP: ".$item_mrp);
                $pdf->Ln();
                $pdf->cell(50);
                $pdf->Cell(40, 10, "Design No.: ".$design_no);
                if(trim($item->cdesp)!=""){
                    $pdf->Ln();
                    $ctxt = "Category Description: ".$item->cdesp;
                    //$pdf->Cell(40, 10, "Category Description: ".$item->cdesp);
                    $pdf->CellFitScale(0,10,$ctxt,0,1,'',0);
                    $pdf->Ln();  
                }
                $pdf->Ln();
                $pdf->cell(50);
                $pdf->Cell(40, 10, "Production Type: ".$productName);
                $pdf->Ln();
                $pdf->Ln();
                $pdf->Ln();
//                $pdf->SetAutoPageBreak(true);
            }
            }
//            exit();
//            $pdf->Output();exit();
            if($count>0)
                {
            $parent_dir = __DIR__;
            
            $dir=$parent_dir.'/pdf_files/';
//            $dir="C:/xampp/htdocs/linenking/home/lib/grnPDFClass/pdf_files/";
//            $dir='pdf_files/';
//                    print_r($dir);exit();
            $date = date('Y_m_d_h_i_s');
            $ctg_space_replace = str_replace(" ", "_", $category_name);
            //$filename = $ctg_space_replace."_".$date.".pdf";
            $filename = "Designs_Released_".$date.".pdf";
            $pdf_path = $db->safe($dir.$filename);

            //Insert into new table it_grn_pdfs.
//            $query = "insert into it_grn_pdfs set pdf_file_path=$pdf_path,createtime=now()";
//            $pdf_id = $db->execInsert($query);
//            $db->closeConnection();

            //Downlaod pdf file into pdf_files folder
            //$fname = $dir.$ctg_space_replace."_".$date;
            $fname = $dir."Manua_Designs_Released_".$date;
            $pdf->Output($fname.'.pdf','F');
            chmod($fname.'.pdf', 0777);
            //echo $dir.$filename;


//            $GRN_PDF_Mail = new GRN_PDF_Mail();
//            $ids = $GRN_PDF_Mail->sendMail();
            
            /*$date = date('Y-m-d h::i::s');
            $filename = $category_name."_".$date.".pdf";
            $pdf_path = $db->safe($dir.$filename);

            //Insert into new table it_grn_pdfs.
            $query = "insert into it_grn_pdfs set pdf_file_path=$pdf_path,createtime=now()";
            $pdf_id = $db->execInsert($query);


            //Downlaod pdf file into pdf_files folder
            $fname = $dir.$category_name."_".$date;
            $pdf->Output($fname.'.pdf','F');
            //echo $dir.$filename;


//            $GRN_PDF_Mail = new GRN_PDF_Mail();
//            $ids = $GRN_PDF_Mail->sendMail($pdf_id);
            //echo $dir.$filename;

            //$redirect = "lib/grnPDFClass/GRN/PDF/Mail/pdf_ids=$objs";
            //header("Location: ".DEF_SITEURL.$redirect);
            //exit;
             * */
            
        }
      }
    }
    $db->closeConnection();
    }
}